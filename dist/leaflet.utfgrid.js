/*
 Copyright (c) 2012, Smartrak, David Leaver
 Leaflet.utfgrid is an open-source JavaScript library that provides utfgrid interaction on leaflet powered maps.
 https://github.com/danzel/Leaflet.utfgrid
*/
(function(window,undefined){L.Util.ajax=function(url,cb){window.XMLHttpRequest===undefined&&(window.XMLHttpRequest=function(){try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(a){throw Error("XMLHttpRequest is not supported")}});var response,request=new XMLHttpRequest;return request.open("GET",url),request.onreadystatechange=function(){request.readyState===4&&request.status===200&&(window.JSON?response=JSON.parse(request.responseText):response=eval("("+request.responseText+")"),cb(response))},request.send(),request},L.UtfGrid=(L.Layer||L.Class).extend({includes:L.Mixin.Events,options:{subdomains:"abc",minZoom:0,maxZoom:18,tileSize:256,resolution:4,useJsonP:!0,pointerCursor:!0,maxRequests:4,requestTimeout:6e4},_mouseOn:null,_requests:{},_request_queue:[],_requests_in_process:[],initialize:function(a,b){L.Util.setOptions(this,b),this._url=a,this._cache={};var c=0;while(window["lu"+c])c++;this._windowKey="lu"+c,window[this._windowKey]={};var d=this.options.subdomains;typeof this.options.subdomains=="string"&&(this.options.subdomains=d.split(""))},onAdd:function(a){this._map=a,this._container=this._map._container,this._update();var b=this._map.getZoom();if(b>this.options.maxZoom||b<this.options.minZoom)return;a.on("click",this._click,this),a.on("mousemove",this._move,this),a.on("moveend",this._update,this)},onRemove:function(){var a=this._map;a.off("click",this._click,this),a.off("mousemove",this._move,this),a.off("moveend",this._update,this),this.options.pointerCursor&&(this._container.style.cursor="")},setUrl:function(a,b){return this._url=a,b||this.redraw(),this},redraw:function(){this._request_queue=[];for(var a in this._requests)this._requests.hasOwnProperty(a)&&this._abort_request(a);this._cache={},this._update()},_click:function(a){this.fire("click",this._objectForEvent(a))},_move:function(a){var b=this._objectForEvent(a);b.data!==this._mouseOn?(this._mouseOn&&(this.fire("mouseout",{latlng:a.latlng,data:this._mouseOn}),this.options.pointerCursor&&(this._container.style.cursor="")),b.data&&(this.fire("mouseover",b),this.options.pointerCursor&&(this._container.style.cursor="pointer")),this._mouseOn=b.data):b.data&&this.fire("mousemove",b)},_objectForEvent:function(a){var b=this._map,c=b.project(a.latlng),d=this.options.tileSize,e=this.options.resolution,f=Math.floor(c.x/d),g=Math.floor(c.y/d),h=Math.floor((c.x-f*d)/e),i=Math.floor((c.y-g*d)/e),j=b.options.crs.scale(b.getZoom())/d;f=(f+j)%j,g=(g+j)%j;var k=this._cache[b.getZoom()+"_"+f+"_"+g],l=null;if(k&&k.grid){var m=this._utfDecode(k.grid[i].charCodeAt(h)),n=k.keys[m];k.data.hasOwnProperty(n)&&(l=k.data[n])}return L.extend({latlng:a.latlng,data:l},a)},_update:function(){var a=this._map.getPixelBounds(),b=this._map.getZoom(),c=this.options.tileSize;if(b>this.options.maxZoom||b<this.options.minZoom)return;var d=new L.Point(Math.floor(a.min.x/c),Math.floor(a.min.y/c)),e=new L.Point(Math.floor(a.max.x/c),Math.floor(a.max.y/c)),f=this._map.options.crs.scale(b)/c,g=[];for(var h=d.x;h<=e.x;h++)for(var i=d.y;i<=e.y;i++){var j=(h+f)%f,k=(i+f)%f,l=b+"_"+j+"_"+k;g.push(l),this._cache.hasOwnProperty(l)||(this._cache[l]=null,this.options.useJsonP?this._loadTileP(b,j,k):this._loadTile(b,j,k))}for(var m in this._requests)g.indexOf(m)<0&&this._abort_request(m)},_loadTileP:function(a,b,c){var d=document.getElementsByTagName("head")[0],e=a+"_"+b+"_"+c,f="lu_"+e,g=this._windowKey,h=this,i=L.Util.template(this._url,L.Util.extend({s:L.TileLayer.prototype._getSubdomain.call(this,{x:b,y:c}),z:a,x:b,y:c,cb:g+"."+f},this.options)),j=document.createElement("script");j.setAttribute("type","text/javascript"),j.setAttribute("src",i),window[g][f]=function(a){h._cache[e]=a,delete window[g][f],d.removeChild(j),h._finish_request(e)},this._queue_request(e,function(){return d.appendChild(j),{abort:function(){d.removeChild(j)}}})},_loadTile:function(a,b,c){var d=L.Util.template(this._url,L.Util.extend({s:L.TileLayer.prototype._getSubdomain.call(this,{x:b,y:c}),z:a,x:b,y:c},this.options)),e=a+"_"+b+"_"+c,f=this;this._queue_request(e,function(){return L.Util.ajax(d,function(a){f._cache[e]=a,f._finish_request(e)})})},_queue_request:function(a,b){this._requests[a]={callback:b,timeout:null,handler:null},this._request_queue.push(a),this._process_queued_requests()},_finish_request:function(a){var b=this._requests_in_process.indexOf(a);b>=0&&this._requests_in_process.splice(b,1),b=this._request_queue.indexOf(a),b>=0&&this._request_queue.splice(b,1),this._requests[a]&&(this._requests[a].timeout&&window.clearTimeout(this._requests[a].timeout),delete this._requests[a]),this._process_queued_requests()},_abort_request:function(a){this._requests[a]&&this._requests[a].handler&&typeof this._requests[a].handler.abort=="function"&&this._requests[a].handler.abort(),this._cache[a]===null&&delete this._cache[a],this._finish_request(a)},_process_queued_requests:function(){while(this._request_queue.length>0&&(this.options.maxRequests===0||this._requests_in_process.length<this.options.maxRequests))this._process_request(this._request_queue.pop())},_process_request:function(a){var b=this;this._requests[a].timeout=window.setTimeout(function(){b._abort_request(a)},this.options.requestTimeout),this._requests_in_process.push(a);var c=this._requests[a].callback();this._requests[a]&&(this._requests[a].handler=c)},_utfDecode:function(a){return a>=93&&a--,a>=35&&a--,a-32}}),L.utfGrid=function(a,b){return new L.UtfGrid(a,b)}})(this);